<?php

namespace App\Services;

use Illuminate\Support\Arr;
use Illuminate\Support\Facades\DB;

class ProgressMessageService
{
    /**
     * Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ù…ÙˆØ¹ ØªØ³Ú©â€ŒÙ‡Ø§ØŒ Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§ØŒ Ø¯Ø±ØµØ¯ Ùˆ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø±.
     */
    public function getUserProgress(int $userId): array
    {
        $agg = DB::table('tasks')
            ->join('goals', 'tasks.goal_id', '=', 'goals.id')
            ->where('goals.user_id', $userId)
            ->selectRaw('COUNT(*) as total, SUM(CASE WHEN tasks.is_done = 1 THEN 1 ELSE 0 END) as done')
            ->first();

        $total = (int) ($agg->total ?? 0);
        $done  = (int) ($agg->done  ?? 0);

        $percent   = $total > 0 ? (int) round(($done / $total) * 100) : 0;
        $remaining = max($total - $done, 0);

        return compact('total', 'done', 'percent', 'remaining');
    }

    /**
     * ØªÙˆÙ„ÛŒØ¯ Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§Ø³Ø§Ø³ Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Û±Û°Ùª.
     * @param string $context  'reminder' | 'report'  (Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡ Ù„Ø­Ù† Ø±Ùˆ Ú©Ù…ÛŒ ØªØºÛŒÛŒØ± Ø¨Ø¯ÛŒÙ…)
     */
    public function buildMessage(int $percent, int $remaining, string $context = 'reminder'): string
    {
        // Ù†Ú¯Ø§Ø´Øª Ø¯Ø±ØµØ¯ Ø¨Ù‡ Ø¨Ø§Ø²Ù‡â€ŒÛŒ Û±Û°Ùª
        $range = (int) floor($percent / 10) * 10;
        if ($range > 100) $range = 100;

        // Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§Ø› Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¨Ø§Ø²Ù‡ Ú†Ù†Ø¯ Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÙˆØ¹
        $messages = [
            0   => [
                "Ø´Ø±ÙˆØ¹ Ù‡Ù…ÛŒØ´Ù‡ Ø³Ø®Øªâ€ŒØªØ±ÛŒÙ† Ø¨Ø®Ø´Ù‡ØŒ Ø§Ù…Ø§ ØªÙˆ Ø§ÙˆÙ„ÛŒÙ† Ù‚Ø¯Ù… Ø±Ùˆ Ø¨Ø±Ø¯Ø§Ø´ØªÛŒ ğŸš€",
                "ÙÙ‚Ø· Ú©Ø§ÙÛŒÙ‡ Ø­Ø±Ú©Øª Ú©Ù†ÛŒØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø±Ø§Ù‡ Ø¢Ø³ÙˆÙ†â€ŒØªØ± Ù…ÛŒØ´Ù‡ ğŸ’¡",
                "Ø§ÙˆÙ„ÛŒÙ† ØªÛŒÚ©ØŒ Ø¬Ø±Ù‚Ù‡â€ŒÛŒ Ù…ÙˆÙÙ‚ÛŒØªÙ‡ âœ¨",
            ],
            10  => [
                "Ø¹Ø§Ù„ÛŒÙ‡! Û±Û°Ùª Ø§Ø² Ù…Ø³ÛŒØ± Ø±Ùˆ Ø±ÙØªÛŒ ğŸ‘",
                "Ù‚Ø¯Ù…â€ŒÙ‡Ø§ÛŒ Ú©ÙˆÚ†ÛŒÚ©ØŒ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø²Ø±Ú¯ Ù…ÛŒâ€ŒØ³Ø§Ø²Ù† ğŸŒ±",
                "Ø´Ø±ÙˆØ¹ Ù…Ø­Ú©Ù…ÛŒ Ø¯Ø§Ø´ØªÛŒØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ ğŸ’ª",
            ],
            20  => [
                "Û²Û°Ùª Ú©Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ ğŸ’ª Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ØŒ Ø±Ø§Ù‡ Ø±Ùˆ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯ÛŒ.",
                "Ù‡Ø± ØªØ³Ú©ÛŒ Ú©Ù‡ ØªÛŒÚ© Ù…ÛŒâ€ŒØ²Ù†ÛŒØŒ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ± Ù…ÛŒØ´ÛŒ ğŸŒŸ",
                "Ù‚Ø¯Ù…â€ŒÙ‡Ø§Øª Ø¯Ø§Ø±Ù† Ù†ØªÛŒØ¬Ù‡ Ù…ÛŒØ¯Ù†ØŒ Û²Û°Ùª Ù¾Ø´Øª Ø³Ø±ØªÙ‡ ğŸ‘Œ",
            ],
            30  => [
                "Û³Û°Ùª Ù¾Ø´Øª Ø³Ø±ØªÙ‡ØŒ Ø¯Ø§Ø±ÛŒ Ø±ÛŒØªÙ… Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ ğŸ¶",
                "Ø§ÛŒÙ† Ø§Ù†Ø±Ú˜ÛŒ Ø±Ùˆ Ù†Ú¯Ù‡ Ø¯Ø§Ø±ØŒ Ø¹Ø§Ù„ÛŒ Ù¾ÛŒØ´ Ù…ÛŒØ±ÛŒ ğŸ”¥",
                "Ù¾ÛŒØ´Ø±ÙØªØª ÙˆØ§Ø¶Ø­Ù‡ØŒ Û³Û°Ùª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ ğŸ‘",
            ],
            40  => [
                "Û´Û°Ùª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ØŒ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡â€ŒØ³Øª ğŸ¯",
                "Ù†Ø²Ø¯ÛŒÚ© Ù†ÛŒÙ…Ù‡ Ù‡Ø³ØªÛŒØŒ Ø¯Ø³Øªâ€ŒÙ…Ø±ÛŒØ²Ø§Ø¯ ğŸ’ª",
                "Ø±Ùˆ ØºÙ„ØªÚ© Ø§ÙØªØ§Ø¯ÛŒØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ âœ¨",
            ],
            50  => [
                "ÛµÛ°Ùª Ú©Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ØŒ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡â€ŒØ³Øª ğŸ¯",
                "Ù†ØµÙ Ø±Ø§Ù‡Ùˆ Ø§ÙˆÙ…Ø¯ÛŒ ğŸ‰ Ø¹Ø§Ù„ÛŒÙ‡!",
                "ÛŒÙ‡ Ù†Ù‚Ø·Ù‡â€ŒÛŒ Ø¹Ø·Ù Ø¨Ø²Ø±Ú¯: Ù†ØµÙ Ú©Ø§Ø±Ø§ Ø±Ùˆ Ø²Ø¯ÛŒ ğŸ‘",
            ],
            60  => [
                "Û¶Û°Ùª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯ØŒ Ø¨ÛŒØ´ Ø§Ø² Ù†ØµÙ Ø±Ùˆ Ø²Ø¯ÛŒ âœ¨",
                "Ù‡Ø± Ù„Ø­Ø¸Ù‡ Ø¯Ø§Ø±ÛŒ Ù‚ÙˆÛŒâ€ŒØªØ± Ù…ÛŒØ´ÛŒ ğŸ’ª",
                "Û¶Û°Ùª ÛŒØ¹Ù†ÛŒ Ø¨ÛŒØ´ØªØ± Ù…Ø³ÛŒØ± Ø±Ùˆ ÙØªØ­ Ú©Ø±Ø¯ÛŒ ğŸ”¥",
            ],
            70  => [
                "Û·Û°Ùª Ø§Ø² Ù…Ø³ÛŒØ± Ø±Ùˆ Ú¯Ø°Ø±ÙˆÙ†Ø¯ÛŒ ğŸ”¥ ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ù‡Ù…Ù‡â€ŒÚ†ÛŒØ² Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡.",
                "Ø®ÛŒÙ„ÛŒ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ù‡Ø³ØªÛŒØŒ Ø¯Ø³Øªâ€ŒÙ…Ø±ÛŒØ²Ø§Ø¯ ğŸ‘",
                "Û·Û°Ùª ÛŒØ¹Ù†ÛŒ Ù¾ÛŒØ±ÙˆØ²ÛŒ Ù†Ø²Ø¯ÛŒÚ©Ù‡ âœ¨",
            ],
            80  => [
                "Û¸Û°Ùª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ¨ ÙÙ‚Ø· Ú©Ù…ÛŒ Ù…ÙˆÙ†Ø¯Ù‡.",
                "ØªÙˆ Ø¯Ø§Ø±ÛŒ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡ Ø¹Ù…Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ ğŸ’¯",
                "Û¸Û°Ùª ÛŒØ¹Ù†ÛŒ Ø§ÙˆØ¬ Ø§Ù†Ø±Ú˜ÛŒ! Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ ğŸš€",
            ],
            90  => [
                "Û¹Û°Ùª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯ ğŸ† ÛŒÚ© Ù‚Ø¯Ù… ØªØ§ Ù¾ÛŒØ±ÙˆØ²ÛŒ.",
                "Ù‡Ù…Ù‡ Ú†ÛŒ Ø±Ùˆ Ø¹Ø§Ù„ÛŒ Ø²Ø¯ÛŒØŒ ÙÙ‚Ø· ÛŒÚ©Ù… Ø¯ÛŒÚ¯Ù‡ Ù…ÙˆÙ†Ø¯Ù‡ ğŸ‰",
                "Û¹Û°Ùª ÛŒØ¹Ù†ÛŒ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø¯Ø³ØªØ§Ù†ØªÙ‡ ğŸ‘",
            ],
            100 => [
                "ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ù‡Ù…Ù‡â€ŒÚ†ÛŒØ² Ú©Ø§Ù…Ù„ Ø´Ø¯ ğŸ¯ Ø§ÙØªØ®Ø§Ø± Ø¨Ù‡Øª Ù…ÛŒâ€ŒÚ©Ù†Ù….",
                "Ø¢Ø®Ø±ÛŒÙ† Ù‚Ø¯Ù… Ø±Ùˆ Ø¨Ø±Ø¯Ø§Ø± Ùˆ Ø¬Ø´Ù† Ø¨Ú¯ÛŒØ± ğŸ¥³",
                "ØµØ¯ Ø¯Ø± ØµØ¯ ÛŒØ¹Ù†ÛŒ ØªÙˆ Ù‚Ù‡Ø±Ù…Ø§Ù† Ø´Ø¯ÛŒ ğŸ‘‘",
            ],
        ];

        // Ù…ØªÙ† Ù¾Ø§ÛŒÙ‡ Ø¨Ø±Ø§Ø³Ø§Ø³ context (ÛŒØ§Ø¯Ø¢ÙˆØ± â†’ ØªØ§Ú©ÛŒØ¯ Ø±ÙˆÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡Ø› Ú¯Ø²Ø§Ø±Ø´ â†’ ØªØ§Ú©ÛŒØ¯ Ø±ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØª)
        $prefix = $context === 'reminder'
            ? ($remaining > 0 ? "Ù‡Ù†ÙˆØ² {$remaining} ØªØ³Ú© Ø¨Ø§Ù‚ÛŒÙ‡. " : "")
            : "Ù¾ÛŒØ´Ø±ÙØª Ú©Ù„ÛŒ: {$percent}Ùª. ";

        return $prefix . Arr::random($messages[$range]);
    }
}
